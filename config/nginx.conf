worker_processes auto;
error_log /var/log/nginx/error.log warn;

events {
  worker_connections 1024;
}

http {
  # No user directive (root ok)

  # Upstream PHP-FPM handler
  upstream php-handler {
    server 127.0.0.1:9000;
  }

  # Rate limiting zones
  limit_req_zone $binary_remote_addr zone=api:10m rate=10r/s;
  limit_req_zone $binary_remote_addr zone=general:10m rate=100r/s;

  # Security: Hide nginx version
  server_tokens off;

  server {
    listen ${PORT:-8080} default_server;
    server_name _;

    root /var/www/html;

    # Client settings
    client_max_body_size 512M;
    client_body_timeout 300s;
    client_header_timeout 60s;
    client_body_buffer_size 512k;

    # FastCGI settings
    fastcgi_buffers 64 4K;
    fastcgi_read_timeout 300s;

    # Gzip compression
    gzip on;
    gzip_vary on;
    gzip_comp_level 4;
    gzip_min_length 256;
    gzip_proxied expired no-cache no-store private no_last_modified no_etag auth;
    gzip_types
      application/atom+xml
      application/javascript
      application/json
      application/ld+json
      application/manifest+json
      application/rss+xml
      application/vnd.geo+json
      application/vnd.ms-fontobject
      application/wasm
      application/x-font-ttf
      application/x-web-app-manifest+json
      application/xhtml+xml
      application/xml
      font/opentype
      image/bmp
      image/svg+xml
      image/x-icon
      text/cache-manifest
      text/css
      text/javascript
      text/plain
      text/vcard
      text/vnd.rim.location.xloc
      text/vtt
      text/x-component
      text/x-cross-domain-policy;

    # Security headers
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "no-referrer" always;
    add_header X-Permitted-Cross-Domain-Policies "none" always;
    add_header X-Robots-Tag "noindex, nofollow" always;
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;

  fastcgi_hide_header X-Powered-By;

  include mime.types;
  types {
    text/javascript mjs;
  }

  index index.php index.html /index.php$request_uri;

  # [DEPLOYMENT] Serve deployment status page during installation
  location = / {
    # Still deploying? Show status page
    if (!-f /var/www/html/.deployment_complete) {
      rewrite ^ /deployment-status.html break;
    }
    # Deployment complete: Handle DAV clients specially
    if ($http_user_agent ~ ^DavClnt) {
      return 302 /remote.php/webdav/$is_args$args;
    }
    # Normal Nextcloud root
    try_files /index.php$request_uri =404;
  }

  # Serve deployment status page directly
  location = /deployment-status.html {
    alias /var/www/html/deployment-status.html;
    add_header Cache-Control "no-cache, no-store, must-revalidate";
    add_header Pragma "no-cache";
    add_header Expires "0";
    add_header Content-Type "text/html";
  }

  # Serve static files
  location ~* \.(html)$ {
    add_header Cache-Control "no-cache, no-store, must-revalidate";
    add_header Pragma "no-cache";
    add_header Expires "0";
  }

  location = /robots.txt {
    allow all;
    log_not_found off;
    access_log off;
  }

  location ^~ /.well-known {
    location = /.well-known/carddav { return 301 /remote.php/dav/; }
    location = /.well-known/caldav  { return 301 /remote.php/dav/; }
    location /.well-known/acme-challenge    { try_files $uri $uri/ =404; }
    location /.well-known/pki-validation    { try_files $uri $uri/ =404; }
    return 301 /index.php$request_uri;
  }

  location ~ ^/(?:build|tests|config|lib|3rdparty|templates|data)(?:$|/)  { return 404; }
  location ~ ^/(?:\.|autotest|occ|issue|indie|db_|console)                { return 404; }

  location ~ \.php(?:$|/) {
    rewrite ^/(?!index|remote|public|cron|core\/ajax\/update|status|ocs\/v[12]|updater\/.+|ocs-provider\/.+|.+\/richdocumentscode(_arm64)?\/proxy) /index.php$request_uri;
    fastcgi_split_path_info ^(.+?\.php)(/.*)$;
    set $path_info $fastcgi_path_info;
    try_files $fastcgi_script_name =404;
    include fastcgi_params;
    fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
    fastcgi_param PATH_INFO $path_info;
    fastcgi_param HTTPS on;
    fastcgi_param modHeadersAvailable true;
    fastcgi_param front_controller_active true;
    fastcgi_pass php-handler;
    fastcgi_intercept_errors on;
    fastcgi_request_buffering on;
    fastcgi_max_temp_file_size 0;
  }

  location ~ \.(?:css|js|mjs|svg|gif|ico|jpg|png|webp|wasm|tflite|map|ogg|flac)$ {
    try_files $uri /index.php$request_uri;
    add_header Cache-Control "public, max-age=15778463";
    add_header Referrer-Policy "no-referrer" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Permitted-Cross-Domain-Policies "none" always;
    add_header X-Robots-Tag "noindex, nofollow" always;
    access_log off;
  }

  location ~ \.(otf|woff2?)$ {
    try_files $uri /index.php$request_uri;
    expires 7d;
    access_log off;
  }

  location /remote {
    return 301 /remote.php$request_uri;
  }
}
}
